{% extends "base.html" %}

{% block title %}استعلام بالرقم القومي{% endblock %}

{% block content %}
<h2>استعلام عن مقترض بالرقم القومي</h2>

<form method="get" class="toolbar inline" action="{% url 'loans:inquiry' %}">
  <label>الرقم القومي:
    <input type="text" name="nid" value="{{ nid|default_if_none:'' }}" placeholder="أدخل الرقم القومي" required>
  </label>
  <button type="submit" class="btn">بحث</button>

  {% if nid %}
    <a class="btn" href="{% url 'loans:inquiry_export_xlsx' %}?nid={{ nid }}">تصدير إلى Excel</a>
  {% endif %}
</form>

<hr>

{% if borrower %}
  <h3>البيانات الشخصية للمقترض</h3>
  <table class="table info">
    <tbody>
      <tr>
        <th>الاسم</th>
        <td>{{ borrower.full_name|default:"-" }}</td>
        <th>الرقم القومي</th>
        <td>{{ borrower.national_id|default:"-" }}</td>
      </tr>
      <tr>
        <th>العنوان</th>
        <td>{{ borrower.address|default:"-" }}</td>
        <th>الهاتف</th>
        <td>{{ borrower.phone|default:"-" }}</td>
      </tr>
      <tr>
        <th>نوع المقترض</th>
        <td>
          {% if borrower.borrower_type == 'employee' %}ضمن الموظفين{% elif borrower.borrower_type == "external" %}خارج الموظفين{% else %}-{% endif %}
        </td>
        <th>عدد القروض</th>
        <td>{{ loans|length }}</td>
      </tr>
    </tbody>
  </table>

  <h3>ملخص القروض</h3>
  <table class="table info">
    <tbody>
      <tr>
        <th>إجمالي القروض</th>
        <td>{{ agg.total|default:0 }}</td>
        <th>إجمالي المسدد</th>
        <td>{{ agg.paid|default:0 }}</td>
      </tr>
      <tr>
        <th>إجمالي المتبقي</th>
        <td>{{ agg.remaining|default:0 }}</td>
        <th>آخر تحصيل</th>
        <td>
          {{ agg.latest_collection_at|date:"Y-m-d H:i"|default:"-" }}
        </td>
      </tr>
    </tbody>
  </table>

  <h3>تفاصيل القروض</h3>
  <table class="table">
    <thead>
    <tr>
      <th>رقم القرض</th>
      <th>قيمة القرض</th>
      <th>نوع السداد</th>
      <th>الحالة</th>
      <th>القسط الشهري</th>
      <th>إجمالي المسدد</th>
      <th>المتبقي</th>
      <th>تاريخ الاستلام</th>
      <th>تاريخ الاستحقاق</th>
      <th>آخر مبلغ تحصيل</th>  {# ← الجديد #}
      <th>آخر تحصيل</th>
    </tr>
  </thead>
  <tbody>
    {% for loan in loans %}
      <tr>
        <td>{{ loan.loan_number }}</td>
        <td>{{ loan.amount }}</td>
        <td>
          {% if loan.repayment_type == 'monthly' %}أقساط شهرية
          {% elif loan.repayment_type == 'oneoff' %}دفعة واحدة
          {% else %}-{% endif %}
        </td>
        <td>
          {% if loan.status == 'active' %}مستمر
          {% elif loan.status == 'closed' %}مكتمل
          {% elif loan.status == 'bad_debt' %}ديون معدومة
          {% else %}-{% endif %}
        </td>
        <td>
          {% if loan.repayment_type == 'monthly' %}
            {{ loan.monthly_installment|default:"-" }}
          {% else %}-{% endif %}
        </td>
        <td>{{ loan.total_paid|default:0 }}</td>
        <td>{{ loan.total_remaining|default:0 }}</td>
        <td>
          {% if loan.received_at %}{{ loan.received_at|date:"Y-m-d" }}{% else %}-{% endif %}
        </td>
        <td>
          {% if loan.maturity_date %}{{ loan.maturity_date|date:"Y-m-d" }}{% else %}-{% endif %}
        </td>

        {# ← الجديد: آخر مبلغ تحصيل #}
        <td>
          {% if loan.last_collect_amount_anno %}
            {{ loan.last_collect_amount_anno|floatformat:2 }}
          {% else %}
            -
          {% endif %}
        </td>

        <td>
          {% if loan.last_collection_at %}{{ loan.last_collection_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}
        </td>
      </tr>
    {% empty %}
      {# بقى عندنا 11 عمود #}
      <tr><td colspan="11">لا توجد قروض لهذا الرقم القومي.</td></tr>
    {% endfor %}
  </tbody>
</table>

{% elif nid %}
  <div class="alert">لا يوجد مقترض بهذا الرقم القومي.</div>
{% else %}
  <p>من فضلك أدخل الرقم القومي ثم اضغط بحث.</p>
{% endif %}

<style>
  .table { width: 100%; border-collapse: collapse; direction: rtl; }
  .table th, .table td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  .table thead th { background: #f2f2f2; }
  .table.info th { background: #fafafa; width: 160px; text-align: right; }
  .toolbar.inline { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
  .btn { padding: 6px 12px; background: #1976d2; color: #fff; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; }
  .btn:hover { background: #125ea3; }
  input[type="text"] { padding: 6px; }
  h2, h3 { margin: 12px 0; }
  hr { margin: 12px 0; }
  .alert { background: #fff3cd; padding: 8px 12px; border: 1px solid #ffeeba; border-radius: 4px; }
</style>
{% endblock %}
