{% extends "base.html" %}
{% block content %}
<div class="container">
  <h1><i class="fas fa-calendar-alt"></i> إدارة مواعيد السُلف</h1>

  <div class="row" style="display:flex; gap:2rem; flex-wrap:wrap; margin-top:1rem;">
    <!-- السُلفة الأولى -->
    <div class="card" style="flex:1; min-width:320px; padding:1rem;">
      <h3>السُلفة الأولى</h3>
      <form method="post" style="margin-top:1rem;">
        {% csrf_token %}
        <input type="hidden" name="which" value="FIRST">
        <div class="form-group">
          <label>من</label>
          <input type="text" id="first_start" name="start_date" class="form-control"
                 value="{{ first_period.start_date.day }}" required>
        </div>
        <div class="form-group">
          <label>إلى</label>
          <input type="text" id="first_end" name="end_date" class="form-control"
                 value="{{ first_period.end_date.day }}" required>
        </div>
        <div class="form-group" style="margin:.5rem 0;">
          <label>
            <input type="checkbox" name="is_active" {% if first_period.is_active %}checked{% endif %}>
            مفعّلة
          </label>
        </div>
        <button type="submit" class="btn"><i class="fas fa-save"></i> حفظ</button>
      </form>
    </div>

    <!-- السُلفة الثانية -->
    <div class="card" style="flex:1; min-width:320px; padding:1rem;">
      <h3>السُلفة الثانية</h3>
      <form method="post" style="margin-top:1rem;">
        {% csrf_token %}
        <input type="hidden" name="which" value="SECOND">
        <div class="form-group">
          <label>من</label>
          <input type="text" id="second_start" name="start_date" class="form-control"
                 value="{{ second_period.start_date.day }}" required>
        </div>
        <div class="form-group">
          <label>إلى</label>
          <input type="text" id="second_end" name="end_date" class="form-control"
                 value="{{ second_period.end_date.day }}" required>
        </div>
        <div class="form-group" style="margin:.5rem 0;">
          <label>
            <input type="checkbox" name="is_active" {% if second_period.is_active %}checked{% endif %}>
            مفعّلة
          </label>
        </div>
        <button type="submit" class="btn"><i class="fas fa-save"></i> حفظ</button>
      </form>
    </div>
  </div>

  <div style="margin-top:1.5rem;">
    <a class="btn" href="{% url 'adv-requests' %}"><i class="fas fa-list"></i> الذهاب لطلبات السُلف</a>
  </div>
</div>

<!-- Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  function initDayOnlyPicker(id, initialDay) {
    let today = new Date();
    flatpickr(id, {
      dateFormat: "d",   // نخزن اليوم فقط
      defaultDate: initialDay ? initialDay : today, // لو في قيمة جاية من السيرفر استخدمها
      minDate: "today",
      onReady: function(selectedDates, dateStr, instance) {
        // ثبّت الشهر والسنة فقط
        instance.currentYear = today.getFullYear();
        instance.currentMonth = today.getMonth();
        instance.redraw();
      },
      onMonthChange: function(selectedDates, dateStr, instance) {
        // لو حاول يغيّر الشهر → نرجعه للشهر الحالي
        instance.currentYear = today.getFullYear();
        instance.currentMonth = today.getMonth();
        instance.redraw();
      },
      onYearChange: function(selectedDates, dateStr, instance) {
        // لو حاول يغيّر السنة → نرجعها للسنة الحالية
        instance.currentYear = today.getFullYear();
        instance.redraw();
      }
    });
  }

  // استدعاء مع القيمة الحالية من السيرفر
  initDayOnlyPicker("#first_start", "{{ first_period.start_date.day }}");
  initDayOnlyPicker("#first_end", "{{ first_period.end_date.day }}");
  initDayOnlyPicker("#second_start", "{{ second_period.start_date.day }}");
  initDayOnlyPicker("#second_end", "{{ second_period.end_date.day }}");
</script>
{% endblock %}
